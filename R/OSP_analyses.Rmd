---
title: "COVID19 in Lithuania - visualisations"
author: "Richard Martin-Nielsen"
output:
  html_document:
    fig_width: 6
    fig_height: 6
    df_print: paged
    self_contained: false
---
```{r, include=FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>",
  message=FALSE, 
  warning=FALSE,
  echo=FALSE
)
  #fig.path = "../_site/", dev="png"
```

```{r setup}
knitr::opts_chunk$set(warning = FALSE, message = FALSE)
library(tidyverse)
library(ggplot2)
library(gghighlight)
library(ggpubr)
library(ggforce)
library(ggridges)
#library(EpiEstim)
library(lubridate)
if (packageVersion("covidregionaldata") > "0.8.5") {
  devtools::install_github("epiforecasts/covidregionaldata", ref="dev")
}
library(covidregionaldata)
library(roll)
library(scales)
library(patchwork)
library(gganimate)

theme_set(theme_minimal()
          + theme(legend.position = "bottom"))
```

```{r load data, include=FALSE}

lt_county_data <- get_regional_data(country="Lithuania",
                                    totals=FALSE,
                                    level = 1,
                                    localise_regions = TRUE,
                                    all_osp_fields = TRUE)

lt_municipality_data <- get_regional_data(country="Lithuania",
                                    totals=FALSE,
                                    level = 2,
                                    localise_regions = TRUE,
                                    all_osp_fields = TRUE)

ltu_national_data <- get_regional_data(country="Lithuania",
                                    totals=FALSE,
                                    level = 2,
                                    localise_regions = TRUE,
                                    all_osp_fields = TRUE,
                                    national_data = TRUE) %>%
  filter(municipality == "Lietuva") %>%
  select(-municipality, -iso_3166_2_municipality, -county, -iso_3166_2)

# ltu_interventions <- get_interventions_data() %>% 
#   filter(iso=="LTU") %>%
#   select(-admin_level_name, -pcode, -comments, -non_compliance, -source,
#          -source_type, -link, -`alternative source`)
```

Two charts imitating those prepared by the OSP in [their analyses](https://osp.stat.gov.lt/documents/10180/8420714/1_COVID-19_situacijos_apzvalga_210215.pdf).

```{r municipality case counts}
lt_counts<- lt_municipality_data %>% 
  select(date,cases_new,municipality) %>%
  mutate(weekly_mean_cases=roll_mean(cases_new,7)) %>%
  filter(date>"2020-10-01") %>%
  group_by(date,
           group=fct_rev(cut(weekly_mean_cases, 
                             breaks=c(-1,0,5,10,15,20,Inf),
                             labels=c("0", "0-5", "5-10", "10-15", "15-20","20+"),
                             include.lowest=TRUE))) %>%
  summarise(count=n())

lt_counts %>%
  ggplot() +
  geom_col(mapping=aes(x=date,y=count,fill=group),width=1) +
  labs(x="Date", y="Number of municipalities", 
       title="Municipality case counts in Lithuania",
       subtitle="7 day average counts of new cases",
       caption="Richard Martin-Nielsen / Data: Official Statistics Portal") +
  scale_fill_brewer(palette="Blues",direction=1)
```

```{r municipality test positivity}
lt_positivity<- lt_municipality_data %>% 
  filter(date>"2020-10-01") %>%
  select(date,dgn_prc_day,municipality) %>%
  mutate(weekly_mean_positivity=roll_mean(dgn_prc_day,7)) %>%
  group_by(date,
           group=fct_rev(cut(dgn_prc_day, 
                             breaks=c(-1,0,5,10,15,20,Inf),
                             labels=c("0%", "0-5%", "5-10%", "10-15%", "15-20%","20%+"),
                             include.lowest=TRUE))) %>%
  summarise(count=n())

lt_positivity %>%
  ggplot() +
  geom_col(mapping=aes(x=date,y=count,fill=group),width=1) +
  labs(x="Date", y="Number of municipalities", 
       title="Municipality test positivity in Lithuania",
       subtitle="7 day average test positivity",
       caption="Richard Martin-Nielsen / Data: Official Statistics Portal") +
  scale_fill_brewer(palette="Oranges",direction=1)
```


```{r compare death criteria counts}

ltu_national_data %>% 
  ggplot(aes(x=date)) +
  geom_col(aes(y=daily_deaths_def3), color="grey70",width=1) +
  geom_col(aes(y=daily_deaths_def2), color="grey50", width=1) +
  geom_col(aes(y=daily_deaths_def1), color="black",width=1) +
  labs(x="Date", y="Deaths", 
       title="Different counts of deaths due to COVID in Lithuania",
       subtitle = "Deaths 'by', 'with' or 'after' COVID",
       caption="Richard Martin-Nielsen / Data: Official Statistics Portal") 
```


```{r testing vs incidence}

coeff <- 4
coeff <- floor(max(ltu_national_data$tested_new) / max(ltu_national_data$cases_new))
tests_colour <- rgb(0,0,1)
cases_colour <- rgb(1,0,0)
p1<- ltu_national_data %>%
  mutate(biweekly_mean_cases=roll_mean(cases_new,7),
         biweekly_mean_tests=roll_mean(tested_new,7)) %>%
  mutate(cases_per_test = biweekly_mean_cases / biweekly_mean_tests) %>%
  ggplot(aes(x=date)) +
  geom_line(aes(y=biweekly_mean_cases),colour=cases_colour) +
  geom_line(aes(y=biweekly_mean_tests/coeff),colour=tests_colour) +
  scale_y_continuous(name="Cases",
                     sec.axis = sec_axis(~.*coeff, name = "Tests"))
p2 <- ltu_national_data %>%
  mutate(biweekly_mean_cases=roll_mean(cases_new,7),
         biweekly_mean_tests=roll_mean(tested_new,7)) %>%
  mutate(cases_per_test = biweekly_mean_cases / biweekly_mean_tests) %>%
  ggplot(aes(x=date)) +
  geom_line(aes(y=cases_per_test),colour="grey75") +
  scale_y_continuous(name="Cases / Test", labels=label_percent(), sec.axis = dup_axis())

narrowed_interventions <- ltu_interventions %>% 
  filter(log_type != "Phase-out measure", 
         measure %in% c("Limit public gatherings", "Partial lockdown", "Domestic travel restrictions", "Schools closure", "Checkpoints within the country",
                                                         "Border closure")) 
p3 <- narrowed_interventions%>%
  ggplot() +
  scale_x_date(limits = c(min(ltu_national_data$date), max(ltu_national_data$date))) +
  geom_point(aes(x=date_implemented,y=1,colour=category)) +
  theme(legend.position = "bottom")
#p1 / p2 / p3 + plot_layout(heights=c(1.5,0.5,0.25))

p1 / p2 + plot_layout(heights=c(1.5,0.5))

```

## Acceleration

Acceleration based on the change in the 7 day averages of the number
of new cases and the test positivity can be used as a more responsive
indicator of the trends of the pandemic.

```{r national acceleration}


ltu_national_data %>% 
  # put rolling 7 day average in here
  mutate(weekly_mean_cases=roll_mean(cases_new,7),
         weekly_mean_positivity=roll_mean(dgn_prc_day,7)) %>%
  mutate(cases_accel=((weekly_mean_cases-lag(weekly_mean_cases))/abs(lag(weekly_mean_cases))),
         test_accel= ((weekly_mean_positivity-lag(weekly_mean_positivity))/abs(lag(weekly_mean_positivity)))) %>%
  filter(date>"2020-09-01") %>%
  select(date, cases_accel, test_accel) %>%
  pivot_longer(cols = ends_with("_accel"), 
               values_to = "accel", 
               names_to = "type", names_pattern="(.*)_accel") %>%
  mutate(type=if_else(type=="test", "test positivity", type)) %>%
  ggplot(aes(x=date, y=accel, colour=type)) +
   geom_line() +
  scale_x_date(date_breaks = "1 month", date_labels = "%B") +
  #scale_y_continuous(trans = modulus_trans(-0.5), labels=label_percent()) +
    scale_y_continuous( labels=label_percent()) +
  geom_hline(yintercept=0, size=0.2) +
    labs(x="Date", y="Acceleration", 
       title="Acceleration of the COVID-19 pandemic in Lithuania",
       subtitle = "% change in 7-day average of incidence or test positivity",
       caption="Richard Martin-Nielsen / Data: Official Statistics Portal") 

```

Acceleration can also be calculated on a municipality-by-municipality
basis.

```{r acceleration calculations}

lt_municipality_data %>% select(date,municipality,cases_new,dgn_prc_day) %>%
  # put rolling 7 day average in here
  group_by(municipality) %>%
  mutate(weekly_mean_cases=roll_mean(cases_new,14),
         weekly_mean_positivity=roll_mean(dgn_prc_day,14)) %>%
  mutate(cases_accel=((weekly_mean_cases-lag(weekly_mean_cases))/abs(lag(weekly_mean_cases))),
         test_accel= ((weekly_mean_positivity-lag(weekly_mean_positivity))/abs(lag(weekly_mean_positivity)))) %>%
  filter(date>"2020-12-01",municipality!="Unknown") %>%
    select(date, cases_accel, test_accel, municipality) %>%
  pivot_longer(cols = ends_with("_accel"), 
               values_to = "accel", 
               names_to = "type", names_pattern="(.*)_accel") %>%
  mutate(type=if_else(type=="test", "test positivity", type)) %>%
  ggplot(aes(x=date, y=accel, colour=type)) +

  facet_wrap_paginate(~municipality, ncol = 10) +
   geom_line() +
    scale_x_date(date_breaks = "1 month", date_labels = "%B") +
  #scale_y_continuous(trans = modulus_trans(-0.5), labels=label_percent()) +
    scale_y_continuous( labels=label_percent()) +
  geom_hline(yintercept=0, size=0.2) +
    labs(x="Date", y="Acceleration", 
       title="Acceleration of the COVID-19 pandemic in Lithuania",
       subtitle = "% change in 7-day average of incidence or test positivity",
       caption="Richard Martin-Nielsen / Data: Official Statistics Portal") 
```

```{r city municipalities}
city_municipalities <- grep("m. sav.", unique(lt_municipality_data$municipality), fixed=TRUE, value=TRUE) 

lt_municipality_data %>% select(date,municipality,cases_new,dgn_prc_day) %>%
  # put rolling 7 day average in here
  group_by(municipality) %>%
  mutate(weekly_mean_cases=roll_mean(cases_new,14),
         weekly_mean_positivity=roll_mean(dgn_prc_day,14)) %>%
  mutate(cases_accel=((weekly_mean_cases-lag(weekly_mean_cases))/abs(lag(weekly_mean_cases))),
         test_accel= ((weekly_mean_positivity-lag(weekly_mean_positivity))/abs(lag(weekly_mean_positivity)))) %>%
  mutate(max_accel = pmax(cases_accel,test_accel)) %>%
  filter(date>"2020-12-01",municipality!="Unknown") %>%
  select(date, cases_accel, test_accel, max_accel,municipality) %>%
  pivot_longer(cols = ends_with("_accel"), 
               values_to = "accel", 
               names_to = "type", names_pattern="(.*)_accel") %>%
  mutate(type=if_else(type=="test", "test positivity", type)) %>%
  filter(municipality %in% city_municipalities) %>%
  filter(municipality=="Vilniaus m. sav.") %>%
  ggplot(aes(x=date, y=accel, colour=type)) +
  facet_wrap(~municipality, ncol = 2) +
  geom_line() +
  scale_x_date(date_breaks = "1 month", date_labels = "%B") +
  #scale_y_continuous(trans = modulus_trans(-0.5), labels=label_percent()) +
    scale_y_continuous( labels=label_percent()) +
  geom_hline(yintercept=0, size=0.2) +
    labs(x="Date", y="Acceleration", 
       title="Acceleration of the COVID-19 pandemic in Lithuania",
       subtitle = "% change in 7-day average of incidence or test positivity",
       caption="Richard Martin-Nielsen / Data: Official Statistics Portal") 

```
## Test positivity estimates

The fraction of the number of new cases divided by the total number of tests is
often used as a proxy for the test positivity. This graph plots the two against
each other to allow comparison.

```{r test positivity vs cases and testing}

ltu_national_data %>%
  mutate(tests_per_case = if_else(tested_new==0,NA_real_, cases_new / tested_new )) %>%
    mutate(weekly_mean_tests_per_case=roll_mean(tests_per_case,7),
         weekly_mean_positivity=roll_mean(dgn_prc_day,7)) %>%
  ggplot(aes(x=date)) +
  scale_x_date(date_breaks = "3 months", date_minor_breaks = "1 month", date_labels = "%b") +
  scale_y_continuous(labels = label_percent()) +
  geom_line(aes(y=weekly_mean_tests_per_case), color=cases_colour) +
  geom_line(aes(y=weekly_mean_positivity/100), color=tests_colour) +
      labs(x="Date", y="Percentage", 
       title="Comparison of Test Positivity with the Cases/Test ratio",
       #subtitle = "% change in 7-day average of incidence or test positivity",
       caption="Richard Martin-Nielsen / Data: Official Statistics Portal") 

#+
#  scale_y_continuous(trans=log10_trans())
```


```{r top 10 municipality incidence graphs}

region_summaries <-
  lt_municipality_data %>%
  group_by(municipality) %>%
  summarise(min_i=min(cases_new), max_i=max(cases_new),
            median_i=median(cases_new), mean_i=mean(cases_new)) %>%
  rename(region=municipality)

narrowed_regions <- pull(region_summaries %>%slice_max(max_i, n=10) %>%select(region))

narrowed_regional_incidence <- lt_municipality_data %>%
  #filter(date < as_date("2021-01-04")) %>%
  filter(municipality %in% narrowed_regions)

intercity_gap <- 400

ridgeline_labels <- narrowed_regional_incidence %>%
  mutate(y=-as.numeric(factor(municipality))*intercity_gap, region=municipality) %>%
  select(region,y) %>%unique()

narrowed_regional_incidence %>%
  ggplot(aes(x=date,y=-as.numeric(factor(municipality))*intercity_gap,
             height=cases_new, group=municipality)) + #y=as.numeric(municipality)*250
  geom_ridgeline(alpha=0.5,aes(fill=municipality),size=0.25) +
    scale_y_continuous(breaks=ridgeline_labels$y,
                     labels=ridgeline_labels$region,
                     sec.axis = 
                       sec_axis(~ . + 10, name="Daily incidence (confirmed cases)",
                                         labels=rep(c(intercity_gap/2,"0"),10),
                                         breaks=seq(from=-intercity_gap/2,
                                                    to=-intercity_gap*10,
                                                    by=-intercity_gap/2)),
                     name="Region"
                     )+
  scale_x_date(date_breaks = "3 months", date_minor_breaks = "1 month", date_labels = "%b") +
  theme_minimal() +
  theme_ridges() +
  theme(legend.position = "none") +
  labs( x= "Date", y="Region / Incidence",
        title="Regional COVID-19 incidence in Lithuania",
        subtitle = "Top ten municipalities by maximum daily incidence",
        caption="Richard Martin-Nielsen | Data: Official Statistics Portal") +
  theme(axis.text.y = element_text(size=8),
        #axis.text.y.left = element_blank(),
        axis.title.y.left = element_blank())
```




```{r county incidence graphs}

intercity_gap <- 800

ridgeline_labels <- lt_county_data %>%
  filter(county!="Unknown") %>%
  mutate(y=-as.numeric(factor(county))*intercity_gap, region=county) %>%
  select(region,y) %>%unique()

lt_county_data %>%
  filter(county!="Unknown") %>%
  ggplot(aes(x=date,y=-as.numeric(factor(county))*intercity_gap,
             height=cases_new, group=county)) + #y=as.numeric(municipality)*250
  geom_ridgeline(alpha=0.5,aes(fill=county),size=0.25) +
    scale_y_continuous(breaks=ridgeline_labels$y,
                     labels=ridgeline_labels$region,
                     sec.axis = 
                       sec_axis(~ . + 10, name="Daily incidence (confirmed cases)",
                                         labels=rep(c(intercity_gap/2,"0"),10),
                                         breaks=seq(from=-intercity_gap/2,
                                                    to=-intercity_gap*10,
                                                    by=-intercity_gap/2)),
                     name="Region"
                     )+
  scale_x_date(date_breaks = "3 months", date_minor_breaks = "1 month", date_labels = "%b") +
  theme_minimal() +
  theme_ridges() +
  theme(legend.position = "none") +
  labs( x= "Date", y="Region / Incidence",
        title="Regional COVID-19 incidence in Lithuania",
        subtitle = "All counties",
        caption="Richard Martin-Nielsen | Data: Official Statistics Portal") +
  theme(axis.text.y = element_text(size=8),
        #axis.text.y.left = element_blank(),
        axis.title.y.left = element_blank())
```
## References

Data sources from the [Official Statistics Portal](https://osp.stat.gov.lt) and in
particular their [open data set for COVID-19](https://open-data-ls-osp-sdg.hub.arcgis.com/datasets/d49a63c934be4f65a93b6273785a8449_0).
Data is downloaded and processed
using a development version 
of [covidregionaldata](https://github.com/EpiForecasts/covidregionaldata)
